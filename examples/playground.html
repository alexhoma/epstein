<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Epstein playground</title>
    <script type="text/javascript" src="./books.js"></script>
    <script type="text/javascript" src="../dist/epstein.umd.js"></script>
    <link rel="stylesheet" href="./styles.css"/>
  </head>
  <body>
    <main>
      <h1>Search a book</h1>
      <span>
        <b>Index time:</b>
        <span id="index-time"></span></span>
      <input id="search" type="search"/>
      <section>
        <div>
          <h2>Esptein results</h2>
          <span id="epstein-performance-time"></span>
          <div id="epstein-results">No results</div>
        </div>
        <div>
          <h2>Raw results</h2>
          <span id="raw-performance-time"></span>
          <div id="raw-results">No results</div>
        </div>
      </section>
    </main>

    <script type="text/javascript">
      var books = books.map(function transformBooks(book) {
        return {title: book.title, author: book.author, content: book.content};
      });
      function renderPerformance(target, callback) {
        var start = window
          .performance
          .now();
        var callbackResult = callback();
        var end = window
          .performance
          .now();

        var time = end - start;
        document
          .querySelector(`#${target}`)
          .innerHTML = `${time}ms`;

        return callbackResult;
      }
      function renderResults(target, results) {
        var resultsContainer = document.querySelector(`#${target}`);
        resultsContainer.innerHTML = '';

        results.map(function renderResults(result) {
          var div = document.createElement("DIV");
          div.innerHTML = `${result.title} - ${result.author}`;
          resultsContainer.appendChild(div);
        });
      }

      // create books index
      var booksIndex = renderPerformance('index-time', () => epstein(books))

      // Search with Epstein
      document
        .querySelector('#search')
        .addEventListener('input', function onUserSearch(e) {
          var results = renderPerformance('epstein-performance-time', () => booksIndex.search(e.target.value))

          renderResults('epstein-results', results);
        })

      // Search without Epstein
      document
        .querySelector('#search')
        .addEventListener('input', function onUserSearch(e) {
          var results = renderPerformance('raw-performance-time', () => {
            var queryParam = e
              .target
              .value
              .toLowerCase();

            return books.filter(function (book) {
              var found = Object
                .entries(book)
                .some(([, prop]) => {
                  return prop
                    .toLowerCase()
                    .search(queryParam) !== -1
                });

              if (!found) {
                return;
              }

              return book;
            });
          });

          renderResults('raw-results', results);
        })
    </script>
  </body>
</html>